# Authentication Patterns

> **Last Updated:** 2026-01-14
> **Purpose:** Complete reference for all authentication types in ODK Central

---

## Overview

ODK Central supports multiple authentication mechanisms for different use cases:
1. **Cookie Authentication** - Web UI sessions
2. **Bearer Token / Field Key** - Same session token, different delivery methods
3. **Basic Auth** - Direct email/password authentication (no session)
4. **Anonymous** - Public endpoints (login, OIDC, test)

**Key Insight:** Bearer Token and Field Key are the **SAME token system** - just delivered via different mechanisms (header vs URL).

---

## Token System Architecture

### Sessions Table: Single Source of Truth

All tokens (Bearer and Field Key) are stored in the `sessions` table:

```sql
-- From server/lib/model/query/sessions.js
SELECT * FROM sessions
JOIN actors ON actors.id = sessions."actorId"
WHERE token = '<token>'
  AND sessions."expiresAt" > now()
  AND (actors.type <> 'field_key' OR vg_field_key_auth.vg_active = true)
```

**Validation function:** `Sessions.getByBearerToken(token)`
- Used by BOTH Bearer Token and Field Key authentication
- Validates token format (64-character alphanumeric)
- Checks expiration and actor type

---

## Authentication Types

### 1. Cookie Authentication

**Used by:** Web UI (browser users)

**Mechanism:**
- Cookie name: `__Host-session` (HTTPS) or `session` (HTTP)
- Cookie attributes: `httpOnly`, `secure`, `sameSite: 'Strict'`
- Includes CSRF token in separate `__csrf` cookie
- Cookie value: Token from `sessions` table

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Cookie Name** | `__Host-session` / `session` |
| **CSRF Cookie** | `__csrf` |
| **Load** | HIGH (web UI) |
| **Risk** | LOW (session-based) |

**Endpoints:**
- `POST /v1/sessions` - Login (sets cookie)
- `GET /v1/users/current` - Get current user
- All web UI endpoints (most `/v1/` endpoints)

**CSRF Protection:**
```javascript
// For POST requests, CSRF validation required:
// 1. X-Requested-With: XMLHttpRequest header (AJAX)
// 2. __csrf token in request body
```

**WAF Considerations:**
- Cookie-only authentication (no Authorization header)
- CSRF token validation for POST requests
- Session-based rate limiting (5 failures/5min = 10min lock)

---

### 2. Bearer Token / Field Key Authentication

**IMPORTANT:** These are the **SAME token system** with different delivery methods.

#### Shared Token System

**Code location:** `server/lib/http/preprocessors.js:38-65`

**Both use:** `Sessions.getByBearerToken(token)`

**Token format:** 64-character alphanumeric string
- Validated by: `isValidToken()` → `/^[A-Za-z0-9!$]{64}$/`
- Stored in: `sessions.token` column
- Generated by: `generateToken()` in `server/lib/util/crypto.js`

**How they differ:**

| Aspect | Bearer Token | Field Key |
|--------|--------------|-----------|
| **Delivery** | `Authorization: Bearer <token>` header | URL: `/key/<token>` or `?st=<token>` |
| **Created by** | App user login endpoint | Project key creation endpoint |
| **Actor type** | Any (app users, web users) | `field_key` or `public_link` only |
| **Error response** | 401 Unauthorized | 403 Forbidden |
| **Typical use** | Mobile apps submitting data | ODK Collect syncing forms |

#### 2a. Bearer Token (Header-based)

**Used by:** App users (mobile data collectors)

**Code path:**
```javascript
// server/lib/http/preprocessors.js:62-65
else if (authHeader.startsWith('Bearer ')) {
  return Sessions.getByBearerToken(authHeader.substring(7));
}
```

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Header** | `Authorization: Bearer <token>` |
| **Load** | **HIGH** (mobile clients) |
| **Risk** | LOW (expiring tokens) |
| **Token Source** | `/v1/projects/:id/app-users/login` |

**Endpoints:**
- `POST /v1/projects/:id/app-users/login` - Login (returns token)
- `POST /v1/.../submissions` - Submit data
- `GET /v1/.../submissions` - List submissions
- `PATCH /v1/.../submissions/:id` - Update submission
- `GET /v1/.../datasets/:name/entities` - Entity access
- `POST /v1/.../datasets/:name/entities` - Create entity

**Request Example:**
```
POST /v1/projects/1/forms/basic/submissions
Authorization: Bearer ABCDEF123456789...64chars...XYZ
Content-Type: application/json

{ "data": { "name": "John", "age": 30 } }
```

**WAF Considerations:**
- **HIGH LOAD**: Used by all mobile clients
- Tokens expire: Need re-login (TTL configurable)
- IP-based rate limiting on login endpoint (20/15min → 30min lock)
- No CSRF validation (bearer-only)

#### 2b. Field Key (URL-based)

**Used by:** ODK Collect (OpenROSA/OData access)

**Code path:**
```javascript
// server/lib/http/preprocessors.js:38-60
if (context.fieldKey.isDefined()) {
  const key = context.fieldKey.get();  // from URL path or ?st= query
  return Sessions.getByBearerToken(key)  // ← SAME FUNCTION!
    .then((session) => {
      // Must be field_key or public_link actor type
      if ((session.actor.type !== 'field_key') && (session.actor.type !== 'public_link'))
        return reject(Problem.user.insufficientRights());
      return context.with({ auth: Auth.by(session) });
    });
}
```

**Delivery patterns:**
1. Path-based: `/v1/key/{token}/projects/1/formList` (deprecated/rare)
2. Query-based: `/v1/projects/1/formList?st={token}` (common)

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Token Location** | URL path or query param |
| **Load** | **HIGHEST** (ODK Collect sync) |
| **Risk** | LOW (scoped to form) |
| **Error Response** | 403 (not 401) for invalid keys |

**Endpoints:**
- `GET /v1/projects/:id/formList` - OpenROSA form list
- `GET /v1/.../forms/:id/manifest` - OpenROSA manifest
- `POST /v1/.../submission` - OpenROSA submission
- `GET /v1/.../forms/:id.svc/*` - OData queries
- `GET /v1/.../datasets/:name.svc/*` - Entity OData

**Request Examples:**
```
# Query-based (common)
GET /v1/projects/1/formList?st=ABCDEF123456789...64chars...XYZ

# Path-based (deprecated/rare)
GET /v1/key/ABCDEF123456789...64chars...XYZ/projects/1/formList
```

**WAF Considerations:**
- **HIGHEST LOAD**: ODK Collect calls these constantly during sync
- Token in URL: Can be logged by proxies/servers (security consideration)
- Returns 403 (not 401) for invalid tokens (prevents credential prompts)
- No CSRF validation
- **URL logging security**: Tokens in query params may be logged

---

### 3. Basic Authentication

**Used by:** Direct API access, scripts, legacy clients

**IMPORTANT:** This does **NOT** create a session - it authenticates every request directly.

**Mechanism:**
- Header: `Authorization: Basic <base64(email:password)>`
- Email/password verified **per request** using bcrypt
- **No session created** - direct authentication
- **Very slow** - bcrypt on every request (hundreds of ms)
- Disabled when: OIDC is enabled

**Code path:**
```javascript
// server/lib/http/preprocessors.js:67-93
else if (authHeader.startsWith('Basic ')) {
  if (oidc.isEnabled()) return reject(Problem.user.basicAuthNotSupportedWhenOidcEnabled());

  // HTTPS check
  if ((context.protocol !== 'https') && (context.headers['x-forwarded-proto'] !== 'https'))
    return reject(Problem.user.httpsOnly());

  // Decode base64: email:password
  const plainCredentials = Buffer.from(authHeader.substring(6), 'base64').toString('utf8');
  const match = /^([^:]+):(.+)$/.exec(plainCredentials);
  const [ , email, password ] = match;

  // Verify credentials (bcrypt - SLOW!)
  return Users.getByEmail(email)
    .then((user) => verifyPassword(password, user.password))
    .then((verified) => {
      if (verified === true)
        return context.with({ auth: Auth.by(user.actor) });  // ← No session!
    });
}
```

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Header** | `Authorization: Basic <credentials>` |
| **Load** | LOW (discouraged, slow) |
| **Risk** | LOW (bcrypt, HTTPS only) |
| **Performance** | **Very slow** (bcrypt per request) |

**Endpoints:**
- ALL endpoints (can be used anywhere Cookie/Bearer auth is accepted)
- Most commonly: `POST /v1/sessions` for login

**Request Example:**
```
POST /v1/sessions
Authorization: Basic am9obkBleGFtcGxlLmNvbTpwYXNzd29yZA==
Content-Type: application/json

{ "email": "john@example.com", "password": "password" }
```

**Decoded credentials:**
- `am9obkBleGFtcGxlLmNvbTpwYXNzd29yZA==` → `john@example.com:password`

**WAF Considerations:**
- **HTTPS only** - enforced by server
- **Strongly discouraged** - bcrypt adds hundreds of ms per request
- **Timing normalization** - bcrypt runs even if email doesn't exist (prevents user enumeration)
- **Rate limiting**: 5 failures/5min → 10min lock
- **No session created** - every request re-authenticates

**When to use:**
- One-off scripts/automation
- Testing/diagnostics
- Cases where managing sessions is impractical
- **NOT recommended** for regular API usage due to performance

---

### 4. Anonymous Access

**Used by:** Public endpoints

**Endpoints:**
| Route | Purpose | Load |
|-------|---------|------|
| `POST /v1/sessions` | Login (self-authenticating) | HIGH |
| `POST /v1/users/reset/initiate` | Password reset start | LOW |
| `POST /v1/users/reset/verify` | Password reset verify | LOW |
| `GET/POST /v1/oidc/*` | OIDC SSO flow | LOW |
| `GET/POST /v1/test/:key/...` | Draft form testing | MEDIUM |
| `POST /v1/projects/:id/app-users/login` | App user login | **HIGH** |

**WAF Considerations:**
- Login endpoints have rate limiting (IP-based)
- OIDC endpoints must be public (SSO flow)
- Test endpoints validate token server-side

---

## Authentication Comparison

### Token-based vs Password-based

| Aspect | Token (Bearer/Field Key) | Basic Auth |
|--------|-------------------------|------------|
| **Storage** | `sessions` table | No storage (direct verify) |
| **Validation** | Token lookup (fast) | Bcrypt (very slow) |
| **Performance** | Fast | Slow (hundreds of ms) |
| **Session created** | Yes | No |
| **Per-request auth** | Token lookup | Bcrypt verify |

### Bearer vs Field Key (Same Token, Different Delivery)

| Aspect | Bearer | Field Key |
|--------|--------|-----------|
| **Token format** | 64-char alphanumeric | 64-char alphanumeric (SAME) |
| **Validation** | `Sessions.getByBearerToken()` | `Sessions.getByBearerToken()` (SAME) |
| **Storage** | `sessions` table | `sessions` table (SAME) |
| **Delivery** | Authorization header | URL path or query param |
| **Actor restriction** | Any type | `field_key` or `public_link` only |
| **Error code** | 401 | 403 |

---

## Authentication by Endpoint Type

### Web UI (Cookie Auth)
```
GET    /v1/users/current
GET    /v1/projects
POST   /v1/projects
PATCH  /v1/projects/:id
DELETE /v1/projects/:id
```

### App Users (Bearer Auth - Same Token System)
```
POST   /v1/projects/:id/app-users/login       (Anonymous -> creates token)
POST   /v1/.../forms/:id/submissions          (Authorization: Bearer <token>)
GET    /v1/.../submissions                    (Authorization: Bearer <token>)
PATCH  /v1/.../submissions/:id                (Authorization: Bearer <token>)
POST   /v1/.../datasets/:name/entities       (Authorization: Bearer <token>)
```

### ODK Collect (Field Key - Same Token, URL Delivery)
```
GET    /v1/projects/:id/formList              (?st=<token> or /key/<token>/...)
GET    /v1/.../forms/:id/manifest             (?st=<token>)
POST   /v1/projects/:id/submission            (?st=<token>)
GET    /v1/.../forms/:id.svc/Submissions      (?st=<token>)
```

### Basic Auth (Can be used anywhere, but discouraged)
```
POST   /v1/sessions                           (Authorization: Basic <creds>)
GET    /v1/projects                           (Authorization: Basic <creds>)
# ... any endpoint ...
```

---

## WAF Configuration by Auth Type

### Cookie Auth (Web UI)
```nginx
# CSRF validation for POST requests
SecRule REQUEST_METHOD "@streq POST" \
    "SecRule REQUEST_HEADERS:Cookie "@rx __Host-session=" \
    "SecRule &REQUEST_HEADERS:X-Requested-With "@eq 0" \
    "SecRule REQUEST_BODY "!@rx __csrf=" \
    "id:3001,phase:2,deny,status=403,msg='CSRF validation failed'"
```

### Bearer/Field Key Auth (Same Token System)
```nginx
# Token validation is done by application
# WAF should not interfere with token delivery

# For Bearer headers:
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer " \
    "id:3002,phase:1,pass,nolog"

# For Field Key in URL (query param):
SecRule REQUEST_URI "@rx \?.*st=" \
    "id:3003,phase:1,pass,nolog"

# For Field Key in URL (path-based):
SecRule REQUEST_URI "@rx /key/[A-Za-z0-9!$]{64}" \
    "id:3004,phase:1,pass,nolog"
```

### Basic Auth (Rate Limiting)
```nginx
# Basic auth is slow (bcrypt) - protect against abuse
SecRule REQUEST_HEADERS:Authorization "@rx ^Basic " \
    "id:3005,phase:1,deny,status=429,\
    setvar:ip.basic_auth_counter=+1,expirevar:ip.basic_auth_counter=60,\
    t:count,deny,msg='Basic auth rate limit exceeded'"
```

---

## Session Security

### Web User Sessions (Cookie)
- **TTL:** 24 hours (86400 seconds) - configurable via `SESSION_LIFETIME`
- **Storage:** `sessions` table in database
- **Cookie:** `__Host-session` (HTTP only, secure, sameSite)
- **Lockout:** 5 failures/5min → 10min lock

### App User Sessions (Bearer/Field Key - Same System)
- **TTL:** 3 days (configurable via `vg_app_user_session_ttl_days`)
- **Cap:** 3 sessions per user (configurable via `vg_app_user_session_cap`)
- **Token:** 64-char alphanumeric string
- **Lockout:** 20 failures/15min → 30min lock (per IP)
- **Format:** `/^[A-Za-z0-9!$]{64}$/`

### Field Key vs App User Tokens

| Aspect | Field Key | App User Token |
|--------|-----------|----------------|
| **Token format** | 64-char alphanumeric (SAME) | 64-char alphanumeric (SAME) |
| **Validation** | `Sessions.getByBearerToken()` (SAME) | `Sessions.getByBearerToken()` (SAME) |
| **Actor type** | `field_key` or `public_link` | Various (not field_key) |
| **Created by** | `POST /v1/projects/:id/key` | `POST /v1/projects/:id/app-users/login` |
| **TTL** | No expiration (unless revoked) | 3 days (configurable) |
| **Use case** | ODK Collect form sync | Mobile app submissions |

---

## Security Headers

### Cookie Attributes
```
Set-Cookie: __Host-session=<token>; HttpOnly; Secure; SameSite=Strict; Path=/
Set-Cookie: __csrf=<token>; HttpOnly; Secure; SameSite=Strict; Path=/
```

### CSRF Headers
```
# AJAX requests must include:
X-Requested-With: XMLHttpRequest

# Or include in POST body:
__csrf=<token>
```

### Authorization Headers
```
# Bearer token (app users)
Authorization: Bearer ABCDEF123456789...64chars...XYZ

# Basic auth (web users - discouraged)
Authorization: Basic am9obkBleGFtcGxlLmNvbTpwYXNzd29yZA==
```

---

## Related Documentation

- **Main WAF Inventory:** `docs/vg/modsecurity-waf-api-inventory.md`
- **App User Auth:** `docs/vg/vg-server/routes/app-user-auth.md`
- **Web User Hardening:** `docs/vg/vg-server/routes/web-user-hardening.md`
- **Lockout System:** `docs/vg/vg-server/routes/lockouts.md`
- **Code Reference:** `server/lib/http/preprocessors.js` (lines 28-138)

---

## Verification Checklist

- [ ] Bearer Token and Field Key documented as same system
- [ ] Basic Auth documented as non-session, slow authentication
- [ ] Token format and validation explained
- [ ] Delivery methods clearly distinguished
- [ ] WAF rules proposed for each auth type
- [ ] Performance considerations noted
- [ ] Security headers specified
