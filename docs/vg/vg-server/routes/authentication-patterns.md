# Authentication Patterns

> **Last Updated:** 2026-01-14
> **Purpose:** Complete reference for all authentication types in ODK Central

---

## Overview

ODK Central supports multiple authentication mechanisms for different use cases:
1. **Cookie Authentication** - Web UI sessions
2. **Bearer Token** - Short-lived app user tokens
3. **Field Key** - Form/submission access tokens
4. **Basic Auth** - Legacy web login (disabled with OIDC)
5. **Anonymous** - Public endpoints (login, OIDC, test)

---

## Authentication Types

### 1. Cookie Authentication

**Used by:** Web UI (browser users)

**Mechanism:**
- Cookie name: `__Host-session` (HTTPS) or `session` (HTTP)
- Cookie attributes: `httpOnly`, `secure`, `sameSite: 'Strict'`
- Includes CSRF token in separate `__csrf` cookie

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Cookie Name** | `__Host-session` / `session` |
| **CSRF Cookie** | `__csrf` |
| **Load** | HIGH (web UI) |
| **Risk** | LOW (session-based) |

**Endpoints:**
- `POST /v1/sessions` - Login (sets cookie)
- `GET /v1/users/current` - Get current user
- All web UI endpoints (most `/v1/` endpoints)

**CSRF Protection:**
```javascript
// For POST requests, CSRF validation required:
// 1. X-Requested-With: XMLHttpRequest header (AJAX)
// 2. __csrf token in request body
```

**WAF Considerations:**
- Cookie-only authentication (no Authorization header)
- CSRF token validation for POST requests
- Session-based rate limiting (5 failures/5min = 10min lock)

---

### 2. Bearer Token Authentication

**Used by:** App users (mobile data collectors)

**Mechanism:**
- Header: `Authorization: Bearer <token>`
- Token type: Short-lived session token
- Generated by: `POST /v1/projects/:id/app-users/login`
- TTL: Configurable via `vg_app_user_session_ttl_days` (default: 3 days)

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Header** | `Authorization: Bearer <token>` |
| **Load** | **HIGH** (mobile clients) |
| **Risk** | LOW (expiring tokens) |
| **Token Source** | `/v1/projects/:id/app-users/login` |

**Endpoints:**
- `POST /v1/projects/:id/app-users/login` - Login (returns token)
- `POST /v1/.../submissions` - Submit data
- `GET /v1/.../submissions` - List submissions
- `PATCH /v1/.../submissions/:id` - Update submission
- `GET /v1/.../datasets/:name/entities` - Entity access
- `POST /v1/.../datasets/:name/entities` - Create entity

**Request Example:**
```
POST /v1/projects/1/forms/basic/submissions
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{ "data": { "name": "John", "age": 30 } }
```

**WAF Considerations:**
- **HIGH LOAD**: Used by all mobile clients
- Tokens expire: Need re-login
- IP-based rate limiting on login endpoint (20/15min → 30min lock)
- No CSRF validation (bearer-only)

---

### 3. Field Key Authentication

**Used by:** ODK Collect (OpenROSA/OData access)

**Mechanism:**
- Two patterns:
  1. Path-based: `/v1/key/{key}/resource_path`
  2. Query-based: `/v1/resource_path?st={token}`
- Token type: Field key (long random string)
- Linked to: `field_keys` table with `actorId`

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Token Location** | URL path or query param |
| **Load** | **HIGH** (ODK Collect) |
| **Risk** | LOW (scoped to form) |
| **Error Response** | 403 (not 401) for invalid keys |

**Endpoints:**
- `GET /v1/projects/:id/formList` - OpenROSA form list
- `GET /v1/.../forms/:id/manifest` - OpenROSA manifest
- `POST /v1/.../submission` - OpenROSA submission
- `GET /v1/.../forms/:id.svc/*` - OData queries
- `GET /v1/.../datasets/:name.svc/*` - Entity OData

**Request Examples:**
```
# Path-based (deprecated/rare)
GET /v1/key/abc123def456/projects/1/formList

# Query-based (common)
GET /v1/projects/1/formList?st=abc123def456
```

**WAF Considerations:**
- **HIGHEST LOAD**: ODK Collect calls these constantly
- Token in URL: Can be logged/proxied
- Returns 403 (not 401) for invalid tokens
- No CSRF validation
- Consider URL logging security (token exposure)

---

### 4. Basic Authentication

**Used by:** Legacy web login

**Mechanism:**
- Header: `Authorization: Basic <base64(email:password)>`
- Disabled when: OIDC is enabled
- Bcrypt password verification

**WAF Attributes:**
| Attribute | Value |
|-----------|-------|
| **Header** | `Authorization: Basic <credentials>` |
| **Load** | HIGH (login) |
| **Risk** | LOW (bcrypt, HTTPS only) |
| **Status** | Disabled with OIDC |

**Endpoints:**
- `POST /v1/sessions` - Login (also accepts cookie-based)

**Request Example:**
```
POST /v1/sessions
Authorization: Basic am9obkBleGFtcGxlLmNvbTpwYXNzd29yZA==
Content-Type: application/json

{ "email": "john@example.com", "password": "password" }
```

**WAF Considerations:**
- HTTPS only in production
- Password normalized (lowercase email, trimmed)
- Timing normalization (bcrypt even if email missing)
- Rate limiting: 5 failures/5min → 10min lock

---

### 5. Anonymous Access

**Used by:** Public endpoints

**Endpoints:**
| Route | Purpose | Load |
|-------|---------|------|
| `POST /v1/sessions` | Login (self-authenticating) | HIGH |
| `POST /v1/users/reset/initiate` | Password reset start | LOW |
| `POST /v1/users/reset/verify` | Password reset verify | LOW |
| `GET/POST /v1/oidc/*` | OIDC SSO flow | LOW |
| `GET/POST /v1/test/:key/...` | Draft form testing | MEDIUM |
| `POST /v1/projects/:id/app-users/login` | App user login | **HIGH** |

**WAF Considerations:**
- Login endpoints have rate limiting (IP-based)
- OIDC endpoints must be public (SSO flow)
- Test endpoints validate token server-side

---

## Authentication by Endpoint Type

### Web UI (Cookie Auth)
```
GET    /v1/users/current
GET    /v1/projects
POST   /v1/projects
PATCH  /v1/projects/:id
DELETE /v1/projects/:id
```

### App Users (Bearer Auth)
```
POST   /v1/projects/:id/app-users/login       (Anonymous -> Bearer)
POST   /v1/.../forms/:id/submissions          (Bearer)
GET    /v1/.../submissions                    (Bearer)
PATCH  /v1/.../submissions/:id                (Bearer)
POST   /v1/.../datasets/:name/entities       (Bearer)
```

### ODK Collect (Field Key Auth)
```
GET    /v1/projects/:id/formList              (Field Key)
GET    /v1/.../forms/:id/manifest             (Field Key)
POST   /v1/projects/:id/submission            (Field Key)
GET    /v1/.../forms/:id.svc/Submissions      (Field Key)
```

### Public (No Auth)
```
POST   /v1/sessions                           (Cookie/Basic)
POST   /v1/users/reset/initiate              (Anonymous)
POST   /v1/projects/:id/app-users/login      (Anonymous, rate-limited)
```

---

## WAF Configuration by Auth Type

### Cookie Auth (Web UI)
```nginx
# CSRF validation for POST requests
SecRule REQUEST_METHOD "@streq POST" \
    "SecRule REQUEST_HEADERS:Cookie "@rx __Host-session=" \
    "SecRule &REQUEST_HEADERS:X-Requested-With "@eq 0" \
    "SecRule REQUEST_BODY "!@rx __csrf=" \
    "id:3001,phase:2,deny,status=403,msg='CSRF validation failed'"
```

### Bearer Auth (App Users)
```nginx
# Require Authorization header for app endpoints
SecRule REQUEST_URI "@rx ^/v1/projects/\d+/app-users/" \
    "SecRule &REQUEST_HEADERS:Authorization "@eq 0" \
    "id:3002,phase:1,deny,status=401,msg='Missing Authorization header'"
```

### Field Key Auth (ODK Collect)
```nginx
# Validate st parameter or /key/ path
SecRule REQUEST_URI "@rx \?.*st=" \
    "id:3003,phase:1,pass,nolog,ctl:ruleEngine=On"
```

### Rate Limiting (Login Endpoints)
```nginx
# Already configured at application level
# Can add WAF-level rate limiting as backup
SecRule REQUEST_URI "@rx /sessions$" \
    "SecRule REQUEST_METHOD "@streq POST" \
    "id:3004,phase:1,deny,status=429,msg='Rate limit exceeded',\
    setvar:ip.login_counter=+1,expirevar:ip.login_counter=300"
```

---

## Session Security

### Web User Sessions
- **TTL:** 24 hours (86400 seconds) - configurable via `SESSION_LIFETIME`
- **Storage:** `sessions` table in database
- **Cookie:** `__Host-session` (HTTP only, secure, sameSite)
- **Lockout:** 5 failures/5min → 10min lock

### App User Sessions
- **TTL:** 3 days (configurable via `vg_app_user_session_ttl_days`)
- **Cap:** 3 sessions per user (configurable via `vg_app_user_session_cap`)
- **Token:** Bearer token in Authorization header
- **Lockout:** 20 failures/15min → 30min lock (per IP)

### Field Key Sessions
- **TTL:** No expiration (unless revoked)
- **Cap:** None (one per form/project)
- **Token:** In URL path or query parameter
- **Lockout:** None (application-level only)

---

## Security Headers

### Cookie Attributes
```
Set-Cookie: __Host-session=<token>; HttpOnly; Secure; SameSite=Strict; Path=/
Set-Cookie: __csrf=<token>; HttpOnly; Secure; SameSite=Strict; Path=/
```

### CSRF Headers
```
# AJAX requests must include:
X-Requested-With: XMLHttpRequest

# Or include in POST body:
__csrf=<token>
```

---

## Related Documentation

- **Main WAF Inventory:** `docs/vg/modsecurity-waf-api-inventory.md`
- **App User Auth:** `docs/vg/vg-server/routes/app-user-auth.md`
- **Web User Hardening:** `docs/vg/vg-server/routes/web-user-hardening.md`
- **Lockout System:** `docs/vg/vg-server/routes/lockouts.md`

---

## Verification Checklist

- [ ] All 5 auth types documented
- [ ] Endpoints grouped by auth type
- [ ] WAF rules proposed for CSRF validation
- [ ] Rate limiting noted per auth type
- [ ] Session TTLs documented
- [ ] Security headers specified
