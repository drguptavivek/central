# Telemetry

## Submit telemetry (app user)
**POST /projects/:projectId/app-users/telemetry**

- Auth: App user bearer token (Collect).
- Request (JSON):
  - `deviceId` (mandatory, string): Unique identifier for the device.
  - `collectVersion` (mandatory, string): Version string of the Collect app.
  - `deviceDateTime` (mandatory, ISO datetime): UTC timestamp generated by the device.
  - `location` (optional, object): Geographic coordinates.
    - `latitude` (mandatory if location present, number): Latitude in decimal degrees.
    - `longitude` (mandatory if location present, number): Longitude in decimal degrees.
    - `altitude` (optional, number): Altitude in meters.
    - `accuracy` (optional, number): Horizontal accuracy in meters.
    - `speed` (optional, number): Speed in meters per second.
    - `bearing` (optional, number): Bearing in degrees.
    - `provider` (optional, string): Source of the location (e.g., "gps").
  - `event` (optional, object): Single client event payload (see below).
  - `events` (optional, array): Batch of up to 10 events; cannot be provided with `event`.
- Event object:
  - `id` (mandatory, string): Client-generated stable id for dedupe.
  - `type` (mandatory, string): Event type identifier.
  - `occurredAt` (optional, ISO datetime): UTC timestamp when the event occurred.
  - `details` (optional, object): Arbitrary event details.
  - Additional metadata is stored as-is.
- Idempotency: events are upserted on `(appUserId/actorId, deviceId, event.id)` so offline retries do not create duplicates.
- App users only; web users cannot submit telemetry on their behalf.
- `appUserId` (optional, integer) must match the authenticated app user if provided.
- If the bearer token belongs to a different project than `:projectId`, the endpoint returns 404 (project scoped not found).
- Auth path: `VgAppUserAuth.getSessionByToken()` accepts any VG session row where `expires_at IS NULL OR expires_at > now() - interval '2 days'` (2-day grace window on VG session expiry).
- If no VG session row matches that rule, the request returns 401 authentication failed (no telemetry recorded).
- If a VG session exists but the core session lookup `Sessions.getByBearerToken()` fails (revoked/expired in core), telemetry is recorded and the response `status` is `"invalidated"`.
- Response (single event):
  - `status`: `"ok"` or `"invalidated"`.
  - `serverTime`: ISO datetime for when the server processed the request.
  ```json
  {
    "deviceId": "device-123",
    "collectVersion": "Collect/2025.1",
    "deviceDateTime": "2025-12-21T10:00:00.000Z",
    "location": {
      "latitude": 37.7749,
      "longitude": -122.4194,
      "altitude": 10.5,
      "accuracy": 3.2,
      "speed": 0.5,
      "bearing": 42.1,
      "provider": "gps"
    },
    "event": {
      "id": "evt-001",
      "type": "form_opened",
      "occurredAt": "2025-12-21T09:59:00.000Z",
      "details": { "formId": "registration" }
    }
  }
